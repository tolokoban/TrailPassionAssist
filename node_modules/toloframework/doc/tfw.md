ToloFrameWork
=============

Organisation of the source folder
---------------------------------

* `project.tfw.json`: project's configuration file.
* `doc/`: auto-generated documentation.
* `src/`: HTML source files.
  * `src/cls/`: javascript classes.
  * `src/wdg/`: widgets' folder.
* `tmp/`: files used by the compiler to link the project.
* `www/`: resulting project.


Compilation process step by step
--------------------------------

For each HTML file (extension `*.html`) in the directory `src/`, __TFW__ will create an HTML file with the same name in the resulting directory `www/`. From this we can deduce the `*.css` and `*.js` files to compile.


<h3>HTML file</h3>

<h4>Inner styles and javascripts</h4>

We want all the javascript and CSS outside the HTML file. First for clarity reason and also besauce Firefox OS doesn't grant web apps if the javascript is not externalized in a separate file.

We put scripts code into the tag __`innerJS`__ and CSS code into __`innerCSS`__.


<h4>Outer styles and javascripts</h4>

We look for this kind of tags:
``` xml
<link href="mystyle.css" rel="stylesheet" type="text/css" />
<script src="myscript.js"></script>
```
The tag __`outerJS`__ will be an array of javascript files relative to the HTML file, and __`outerCSS`__ an array of CSS files.


<h4>Widgets</h4>

All elements with the namespace `w:` are widgets. If the HTML file contains, for instance, the widgets `<w:foo>` and `<w:bar>`, we put `["wdg/foo/compile-foo.js", "wdg/bar/compile-bar.js"]` into the tag __`dependencies`__.  
Then we eventually add the content of `root.extra.css` to the tag __`innerCSS`__.


<h4>The whole final HTML tree</h4>

There is a last piece of javascript the compiler must write: it deals with _databindings_ and _controllers_.  
Bindable data are scoped, so we must add the property `$data` to some DOM elements. For _controllers_, we use the property `$widget`, but this is not visible in the script because all controllers inherit from `WTag` class which is responsible of attaching this property.

Here is an example of such a script:
``` js
window.addEventListener(
    'DOMContentLoaded',
    function() {
        document.body.parentNode.$data = {};
        var binddata = function(id, name, value) {
            if (typeof document.getElementById(id).$data === 'undefined') {
               document.getElementById(id).$data = {}
            }
            document.getElementById(id).$data[name] = [value, []];
        };
        binddata(5, "score", 0);
        $$('wtag.Button', {id: 7, fire: ["@popup"], fireArg: ["hello"]});
        $$('wtag.List', {
            id: 11,
            maker: function(tpl,id) {
                id += '.';
                $$('wtag.Bind', {id: id + 10, data: "user"});
                $$('wtag.Bind', {id: id + 11, data: "yourname"});
            },
            tpl: 12,
            list: "users",
            item: "user"
        });
        document.body.$widget = $$.App = $$('Main', {id: document.body});
        $$.App.lang($$.App.lang());
        document.body.removeChild(document.getElementById('15'))
    }
);
```

* __line 2__: ensure that this will be executed after le DOM is fully loaded.
* __line 4__: the HTML root element own the global databinding scope.
* __line 5__: function used for local scoped data bindings.
* __line 11__: this line is generated by a Top-Down walk in the tree, if we find `extra.databindings`.
* __line 12__: from here we walk the tree Bottom-Up and attach controllers. 
  In this line, we found `extra.controller = "wtag.Button"` and 
  `extra.init = {id: 7, fire: ["@popup"], fireArg: ["hello"]}`.
* __line 13__: this is an example for a more complex widget.
* __line 24__: if the BODY element has the `app` attribute, we use it as a top controller.
* __line 25__: initialization of internationalization.
* __line 26__: when everything has been successfully initialized, we can remove the black screen.

This script is added to the tag __`innerJS`__, then we remove all the `extra` attributes in the tree and we store it in tag __`tree`__.


<h4>Summary</h4>

* __`innerJS`__: (string) javascript to externalize.
* __`zipJS`__: (string) `innerJS` zipped for RELEASE.
* __`innerCSS`__: (string) style to externalize.
* __`zipCSS`__: (string) `innerCSS` zipped for RELEASE.
* __`outerJS`__: (array) javascript files relative to the HTML file path.
* __`outerCSS`__: (array) stylesheet files relative to the HTML file path.
* __`linkJS`__: (array) complete list of javascript files. This is a subset of __`outerJS`__ because it owns scripts needed by other scripts.
* __`dependencies`__: (array) files that will force recompilation of the HTML files if at least one of them is not uptodate.
* __`tree`__: the final HTMLl tree after removing attributes `extra`.


<h3>Javascript files</h3>

In __ToloFrameWork__, classes intantiations are made with this syntax: `$$("myclass", {...})`.  
Each time the parser meets such a syntax, it adds the class name (_myclass_) in the array tag __`needsJS`__.

If a CSS file is associated (for instance, we found `foo.Bar.css` in the same folder as `foo.Bar.js`) we add it (relative to the HTML file) in tag __`CSS`__.

Finaly, we store the zipped version of this script in tag __`zip`__.

* __`needsJS`__: (array) list of needed classes.
* __`css`__: (string) name of the CSS file relative to this HTML file. It must have the same name, but with extension `.css`.
* __`zip`__: (string) zipped version of this script for RELEASE purpose.


<h3>CSS files</h3>

All CSS used in __TFW__ accept the LESS syntax. That's why the first thing to do is store the LESS expansion of the file in tag __`debug`__. Then, we zip the result and store it in tag __`release`__.

Finaly, we parse the zip CSS looking for `url(...)`. Each time a URL is related to an existing local file, we add it to the array tag __`resources`__.

* __`debug`__: (string) CSS code after LESS has expanded it.
* __`release`__: (string) zipped version of `debug`.
* __`resources`__: (array) zipped version of this script for RELEASE purpose.


Linkage process step by step
----------------------------

Whereas compilation occurs only when files change, the linkage process always occurs.

This process will result in the following directories:
* __www/debug/__: DEBUG version of the webapp. 
  No zipping, all JS and CSS files are separated.
  Inner javascripts are stored in the file `index.js` and inner styles in `index.css`.
  In this mode, a folder `index/` is created to store all the JS and CSS files.
* __www/release/__: RELEASE version of the webapp. 
  All JS and CSS files are zipped and aggregated in respectively `index.js` and `index.css` files.

For both configurations, `index.manifest` is generated with the current date/time.


<h3>Resources</h3>

CSS tags __`resources`__ are used to find resources that we will copy on output and reference in the manifest file `index.manifest`.